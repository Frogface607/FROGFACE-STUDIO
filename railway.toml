[build]
builder = "NIXPACKS"
buildCommand = "pnpm install --prod=false && echo '=== BUILDING PACKAGES EXPLICITLY ===' && echo '1. api-client...' && cd packages/core/api-client && pnpm build && cd /app && echo '2. knowledge-base...' && cd packages/core/knowledge-base && pnpm install && pnpm build && cd /app && echo '3. agent-base...' && cd packages/core/agent-base && pnpm install && pnpm build && cd /app && echo '4. copywriter...' && cd packages/agents/copywriter && pnpm install && pnpm build && cd /app && echo '5. archivist...' && cd packages/agents/archivist && pnpm install && pnpm build && cd /app && echo '6. edison-copywriter...' && cd packages/agents/edison-copywriter && pnpm install && pnpm build && cd /app && echo '7. mcp-server (verifying deps first)...' && cd /app && echo 'Checking if fastify exists in root node_modules:' && ls -la node_modules/fastify 2>&1 | head -3 && echo 'Installing mcp-server deps explicitly...' && cd packages/core/mcp-server && pnpm install --no-frozen-lockfile && echo 'Verifying fastify after install:' && ls -la node_modules/fastify 2>&1 | head -3 || ls -la ../../node_modules/fastify 2>&1 | head -3 && echo 'Building mcp-server...' && pnpm build 2>&1 && cd /app && echo '=== BUILD COMPLETE ===' && echo '=== CHECKING mcp-server ===' && ls -la packages/core/mcp-server/dist/ && echo '=== CHECKING server.js ===' && if test -f packages/core/mcp-server/dist/server.js; then echo '✅✅✅ server.js EXISTS! ✅✅✅'; else echo '❌ server.js NOT FOUND!'; echo 'Files in mcp-server/dist:'; find packages/core/mcp-server/dist -type f 2>/dev/null || echo 'dist directory does not exist'; echo 'All dist directories:'; find packages -type d -name dist 2>/dev/null; echo 'All build outputs:'; find packages -name '*.js' -path '*/dist/*' -type f 2>/dev/null | head -20; exit 1; fi && echo '✅✅✅ READY TO DEPLOY! ✅✅✅'"

[deploy]
startCommand = "cd /app && node packages/core/mcp-server/dist/server.js"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
